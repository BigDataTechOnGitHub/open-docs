<!DOCTYPE html>
<html lang="en">
<head>
<title>Exercise 16: Recreating the Cluster Using Ansible</title>
<meta name="title" content ="Setting up a Single Node Mesosphere Cluster">

<meta name="description" content="Mesos allows you to create a highly-available and scalable cluster on your existing hardware.">

<meta name="keywords" content="mesos, mesosphere, apache mesos, cluster, mesos cluster, apache mesos, mesos tutorial, ETL, long-running services, service automation, distributed kernel, apache marathon, marathon tutorial, chronos tutorial, spark tutorial">
<meta name="googlebot" content="all" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css"
  rel="stylesheet">
<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css"
  rel="stylesheet">
<link rel="stylesheet" href="//dw8zztroqvu2r.cloudfront.net/assets/mesosphere-82a59fe27ee148f819ce1adf64a1bfd8.css">
<link rel="alternate" type="application/atom+xml" title="The Mesosphere Blog" href="/blog/atom.xml">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="//dw8zztroqvu2r.cloudfront.net/assets/apple-touch-icon-114x114-precomposed-e1bad1adfb238c042495e17882a75bee.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="//dw8zztroqvu2r.cloudfront.net/assets/apple-touch-icon-72x72-precomposed-e9561717ad14e807a3a6422bd2cf950d.png">
<link rel="apple-touch-icon-precomposed" href="//dw8zztroqvu2r.cloudfront.net/assets/apple-touch-icon-57x57-precomposed-1c3bb09d559f043cb58f2e36bd9b81bd.png">
<link rel="stylesheet" href="style.css">
    
    <script src="//cdn.optimizely.com/js/2009520669.js"></script>
    <script>
      window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(t){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)},window.analytics.SNIPPET_VERSION="2.0.8",
      window.analytics.load("7sgtwqvuai");
      window.analytics.page();
    </script>

</head>
<body>

<div class="navbar navbar-default  " role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>


            <a class="navbar-brand" href="http://mesosphere.com/">


                <img src="http://dw8zztroqvu2r.cloudfront.net/assets/mesosphere-165b872607f4d76434d9b1cfb41a6280.png" width="148" height="25" alt="Mesosphere">


            </a>
        </div>
        <div class="collapse navbar-collapse">
        </div>
    </div>
</div>

<div class="body-light">
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <div role="complementary">
                    <gcse:searchbox-only></gcse:searchbox-only>
                    <ul class="nav docs-sidenav">
                        <li><a class="reference external" href="intro.html">Introduction</a></li>
                        <li><a class="reference external" href="ex1.html">01: Installing Software</a></li>
                        <li><a class="reference external" href="ex2.html">02: Installing ZooKeeper</a></li>
                        <li><a class="reference external" href="ex3.html">03: Using Apache Mesos</a></li>
                        <li><a class="reference external" href="ex4.html">04: Starting Marathon</a></li>
                        <li><a class="reference external" href="ex5.html">05: Using the Marathon GUI</a></li>
                        <li><a class="reference external" href="ex6.html">06: Marathon REST API</a></li>
                        <li><a class="reference external" href="ex7.html">07: Building and Running Mesos DNS</a></li>
                        <li><a class="reference external" href="ex8.html">08: Installing Chronos</a></li>
                        <li><a class="reference external" href="ex9.html">09: Creating A Slave Node</a></li>
                        <li><a class="reference external" href="ex10.html">10: Installing Mesos</a></li>
                        <li><a class="reference external" href="ex11.html">11: Scaling To Two Nodes</a></li>
                        <li><a class="reference external" href="ex12.html">12: Deploying A Web App With Docker</a></li>
                        <li><a class="reference external" href="ex13.html">13: Distributing Docker To Multiple Nodes</a></li>
                        <li><a class="reference external" href="ex14.html">14: Installing and Using Mesos CLI</a></li>
                        <li><a class="reference external" href="ex15.html">15: Starting Four Nodes</a></li>
                        <li><a class="reference external" href="ex16.html">16: Recreating the Cluster Using Ansible</a></li>
                        <li><a class="reference external" href="ex17.html">17: Advanced Usage of the Marathon</a></li>
                        <li><a class="reference external" href="ex18.html">18: Advanced Usage of Chronos</a></li>
                        <li><a class="reference external" href="ex19.html">19: Troubleshooting</a></li>
                        <li><a class="reference external" href="ex20.html">20: Advanced Cluster Building</a></li>
                    </ul> 
                </div>

            </div>
            <div class="col-md-8">

                <!--- RST STARTS -->
                <h1 class="title">Exercise 16: Recreating the Cluster Using Ansible</h1>
                <p>You have a miniature Mesosphere cluster running on your computer, but what would happen if you had to destroy it and start over?  Luckily we have the <a class="reference external" href="http://www.ansible.com/home">Ansible</a> tool where you can run one command to recreate your entire little cluster.</p>
<p>This exercise shows you how to create an Ansible playbook that can recreate the entire cluster
that you manually created for the last 15 exercises.  You could have started with this, but then you wouldn't
have known all the core concepts of Meso, Marathon, Chronos, and would be lost when you run into
trouble.</p>
<p>In this exercise:</p>
<ol class="arabic simple">
<li>Create a simple <tt class="docutils literal">playbook.yml</tt> file to get the master node working.</li>
<li>Change the <tt class="docutils literal">Vagrantfile</tt> to run Ansible and your playbook when provisioning.</li>
<li>Augment the <tt class="docutils literal">playbook.yml</tt> and <tt class="docutils literal">Vagrantfile</tt> to provision nodes 2-4.</li>
<li>Destroy everything and confirm you can rebuild everything with one command.</li>
</ol>
<div class="section" id="video-lecture">
<h1>Video Lecture</h1>
<style>.smart-player-embed-container-iframe{width:768px;height:576px}.smart-player-full-frame-mode{position:absolute;top:0;left:0;z-index:10;width:100%;height:100%;padding:0;margin:0}</style>
<iframe class="smart-player-embed-container-iframe" id="embeddedSmartPlayerInstance" src="https://s3-us-west-2.amazonaws.com/docs-staging.mesosphere.com/Videos/Mesos-Intro-Course-16/media/index_player.html?embedIFrameId=embeddedSmartPlayerInstance" scrolling="no"  frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<script src="media/scripts/embedded-smart-player.min.js"></script></div>
<div class="section" id="quick-reference">
<h1>Quick Reference</h1>
<p>Destroy the cluster.  If you want, create a new directory and set up a new bare Vagrant install for this instead of destroying the cluster with <tt class="docutils literal">vagrant destroy</tt>.
Create a simple <tt class="docutils literal">playbook.yml</tt> file with this:</p>
<pre class="literal-block">
---
- hosts: master
  remote_user: vagrant
  sudo: yes
  tasks:
      - name: update the hosts file
        template: src=./hosts.j2 dest=/etc/hosts
      - name: install the mesosphere yum repo
        shell: rpm -Uvh http://repos.mesosphere.io/el/7/noarch/RPMS/mesosphere-el-repo-7-1.noarch.rpm
      - name: install zookeeper repo
        shell: rpm -Uvh http://archive.cloudera.com/cdh4/one-click-install/redhat/6/x86_64/cloudera-cdh-4-0.x86_64.rpm
      - name: install zookeeper
        yum: pkg=zookeeper,zookeeper-server state=latest
      - name: configure zookeeper ID
        shell: sudo -u zookeeper zookeeper-server-initialize --myid=1
      - name: install the mesos, marathon, chronos, docker packages
        yum: pkg=mesos,marathon,chronos,docker state=latest
      - name: start up zookeeper
        service: name=zookeeper-server state=started enabled=yes
      - name: start up the mesos-master
        service: name=mesos-master state=started enabled=yes
      - name: make sure mesos-slave is running
        service: name=mesos-slave state=started enabled=yes
      - name: start marathon
        service: name=marathon state=started enabled=yes
      - name: start chronos
        service: name=chronos state=started enabled=yes
      - name: start docker
        service: name=docker state=started enabled=yes
      - name: install go and dns tools
        yum: pkg=golang,git,bind-utils state=latest
      - name: build mesos-dns
        shell: sudo -u vagrant sh /vagrant/installdns.sh
      - name: install outyet
        shell: sudo docker load --input=/vagrant/outyet.tar.gz
</pre>
<p>Replace your <tt class="docutils literal">/etc/hosts</tt> with a file named <tt class="docutils literal">hosts.j2</tt>:</p>
<pre class="literal-block">
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.33.10 node1
192.168.33.11 node2
192.168.33.12 node3
192.168.33.13 node4
</pre>
<p>This will solve the problem of having proper host:ip mappings in our little cluster.
Modify the <tt class="docutils literal">Vagrantfile</tt> to include:</p>
<pre class="literal-block">
ANSIBLE_GROUPS = {
              &quot;master&quot; =&gt; [&quot;node1&quot;],
              &quot;nodes&quot; =&gt; [&quot;node2&quot;, &quot;node3&quot;, &quot;node4&quot;],
              &quot;all_groups:children&quot; =&gt; [&quot;master&quot;, &quot;nodes&quot;]
            }


Vagrant.configure(2) do |config|
    config.vm.box = &quot;chef/centos-7.0&quot;
    config.vm.define &quot;node1&quot; do |node1|
        node1.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.10&quot;
        node1.vm.hostname = &quot;node1&quot;
        node1.vm.provision &quot;ansible&quot; do |ansible|
            ansible.playbook = &quot;playbook.yml&quot;
            ansible.groups = ANSIBLE_GROUPS
        end
    end

    config.vm.define &quot;node2&quot; do |node2|
        node2.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.11&quot;
        node2.vm.hostname = &quot;node2&quot;
        node2.vm.provision &quot;ansible&quot; do |ansible|
            ansible.playbook = &quot;playbook.yml&quot;
            ansible.groups = ANSIBLE_GROUPS
        end
    end


    config.vm.define &quot;node3&quot; do |node3|
        node3.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.12&quot;
        node3.vm.hostname = &quot;node3&quot;
        node3.vm.provision &quot;ansible&quot; do |ansible|
            ansible.playbook = &quot;playbook.yml&quot;
            ansible.groups = ANSIBLE_GROUPS
        end
    end

    config.vm.define &quot;node4&quot; do |node4|
        node4.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.13&quot;
        node4.vm.hostname = &quot;node4&quot;
        node4.vm.provision &quot;ansible&quot; do |ansible|
            ansible.playbook = &quot;playbook.yml&quot;
            ansible.groups = ANSIBLE_GROUPS
        end
    end
end
</pre>
<p>Notice this is now stripped of the default comments and I've done the following to it:</p>
<ul class="simple">
<li>Created an <tt class="docutils literal">ANSIBLE_GROUPS</tt> variable to store our groupings for hosts.</li>
<li>Added a <tt class="docutils literal">node.vm.provision</tt> block to each node.</li>
<li>Added the <tt class="docutils literal">ansible.playbook</tt> and <tt class="docutils literal">ansible.groups</tt> settings inside that.</li>
<li>Removed the use of the <tt class="docutils literal"><span class="pre">mesos-master</span></tt> box from our previous exercises for <tt class="docutils literal">node1</tt>.</li>
</ul>
<p>Enter this command to get <tt class="docutils literal">node1</tt> working:</p>
<pre class="literal-block">
vagrant up node1
</pre>
<p>That should run every single thing necessary to get a master node up.  You should do the
usual tests of Marathon, Chronos, and Mesos as you've learned in Module 1.</p>
<p>Add a part of the <tt class="docutils literal">playbook.yml</tt> that configures the slave nodes
too:</p>
<pre class="literal-block">
- hosts: nodes
  remote_user: vagrant
  sudo: yes
  tasks:
      - name: update the hosts file
        template: src=./hosts.j2 dest=/etc/hosts
      - name: install the mesosphere yum repo
        shell: rpm -Uvh http://repos.mesosphere.io/el/7/noarch/RPMS/mesosphere-el-repo-7-1.noarch.rpm
      - name: install the mesos and docker packages
        yum: pkg=mesos,docker state=latest
      - name: set the zookeeper master
        shell: sed -i -e 's/localhost/192.168.33.10/g' /etc/mesos/zk
      - name: make sure mesos-slave is running
        service: name=mesos-slave state=started enabled=yes
      - name: start docker
        service: name=docker state=started enabled=yes
      - name: install outyet
        shell: sudo docker load --input=/vagrant/outyet.tar.gz
</pre>
<p>Run this command to bring your nodes up:</p>
<pre class="literal-block">
vagrant up
</pre>
<p>And the remaining nodes will come up and be installed, but this time Vagrant will run Ansible to automatically configure everything.  This takes a while, but you can look at the Marathon GUI to watch everything come online while it's running.</p>
</div>
<div class="section" id="further-study">
<h1>Further Study</h1>
<ul class="simple">
<li>Destroy the whole cluster and recreate it with <tt class="docutils literal">vagrant up</tt>.</li>
<li>Review the Ansible documentation and learn more about it.</li>
</ul>
</div>
                <!-- RST ENDS -->

                <h2 id="comments">Ask For Help</h2>
                <p>You can ask for help right here and a Mesosphere employee will respond within 24 hours.  Comments are moderated and will not show immediately.</p>
                <div id="disqus_thread"></div>
                <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'mesospheredocs'; // required: replace example with your forum shortname

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                 dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                 })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


            </div>

        </div>

        <script type="text/javascript">
!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.0.1";
    analytics.load("jb9aik674n");
    analytics.page()
}}();
        </script>
    </div>
    <footer class=" ">
        <div class="container">
            <div class="row">
                <div class="col-sm-3">
                    <ul class="list-unstyled">
                        <li><a href="http://mesosphere.com/team/">Team</a>
                        <li><a href="http://mesosphere.com/news-events/">News &amp; Events</a></li>
                        <li><a href="http://mesosphere.com/jobs/">Careers</a>
                    </ul>
                </div>
                <div class="col-sm-3">
                    <ul class="list-unstyled">
                        <li><a href="http://mesosphere.com/resources/case-studies/">Case Studies</a>
                        <li><a href="http://mesosphere.com/resources/research/">Research</a>
                    </ul>
                </div>
                <div class="col-sm-3">
                    <ul class="list-unstyled">
                        <li><a href="https://twitter.com/mesosphere">@mesosphere</a>
                        <li><span class="text-muted">&copy; 2015 Mesosphere, Inc.</span>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/zeroclipboard/1.3.2/ZeroClipboard.min.js"></script>

    </body>

    </html>
