<!DOCTYPE html>
  <head>
    <title>Mesosphere - Exercise 16: Recreating the Cluster Using Ansible</title>
    <meta name="title" content ="Mesosphere Documentation Intro Course">
    
      <meta name="description" content="Mesos allows you to create a highly-available and scalable cluster on your existing hardware.">
    
    <meta name="keywords" content="mesos, mesosphere, apache mesos, cluster, mesos cluster, apache mesos, mesos tutorial, ETL, long-running services, service automation, distributed kernel, apache marathon, marathon tutorial, chronos tutorial, spark tutorial">
    <meta name="googlebot" content="all" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css"
      rel="stylesheet">
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css"
      rel="stylesheet">
    <link rel="stylesheet" href="/assets/mesosphere-bb1dd6431996c0a6e479673c87a06efc.css">
    <link rel="alternate" type="application/atom+xml" title="The Mesosphere Blog" href="/blog/atom.xml">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/assets/apple-touch-icon-114x114-precomposed-866a1e471ec7ca6bd71446ca972285c6.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/assets/apple-touch-icon-72x72-precomposed-4a308d281d978c5a39fd1893ca051959.png">
    <link rel="apple-touch-icon-precomposed" href="/assets/apple-touch-icon-57x57-precomposed-d7a5a878dcc95e57717cc774eeac8c22.png">
    
    <link rel="stylesheet" href="style.css">
    <script src="//cdn.optimizely.com/js/2009520669.js"></script>
    <script>
      window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(t){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)},window.analytics.SNIPPET_VERSION="2.0.8",
      window.analytics.load("7sgtwqvuai");
      window.analytics.page();
    </script>
    
  </head>
<body>

<div class="body-light">
    <div class="container">
        <div class="row">
            <div class="col-sm-10 col-sm-offset-1">

                <!-- NAV START -->
                <div class="navbar navbar-default navbar-inverse" role="navigation">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>


                        <a class="navbar-brand" href="http://open.mesosphere.com/intro-course/">


                            Advanced Mesos Course


                        </a>
                    </div>
                    <div class="collapse navbar-collapse">
                    </div>
                </div>
                <!-- NAV END -->

                <!-- BODY START -->
                <div class="row">
                    <div class="col-md-3">
                        <div role="complementary">
                            <gcse:searchbox-only></gcse:searchbox-only>
                            <ul class="nav docs-sidenav">
                                <li><a class="reference external" href="intro.html">Introduction</a></li>
                                <li><a class="reference external" href="ex1.html">01: Installing Software</a></li>
                                <li><a class="reference external" href="ex2.html">02: Installing ZooKeeper</a></li>
                                <li><a class="reference external" href="ex3.html">03: Using Apache Mesos</a></li>
                                <li><a class="reference external" href="ex4.html">04: Starting Marathon</a></li>
                                <li><a class="reference external" href="ex5.html">05: Using the Marathon GUI</a></li>
                                <li><a class="reference external" href="ex6.html">06: Marathon REST API</a></li>
                                <li><a class="reference external" href="ex7.html">07: Building and Running Mesos DNS</a></li>
                                <li><a class="reference external" href="ex8.html">08: Installing Chronos</a></li>
                                <li><a class="reference external" href="ex9.html">09: Creating A Slave Node</a></li>
                                <li><a class="reference external" href="ex10.html">10: Installing Mesos</a></li>
                                <li><a class="reference external" href="ex11.html">11: Scaling To Two Nodes</a></li>
                                <li><a class="reference external" href="ex12.html">12: Deploying A Web App With Docker</a></li>
                                <li><a class="reference external" href="ex13.html">13: Distributing Docker To Multiple Nodes</a></li>
                                <li><a class="reference external" href="ex14.html">14: Installing and Using Mesos CLI</a></li>
                                <li><a class="reference external" href="ex15.html">15: Starting Four Nodes</a></li>
                                <li><a class="reference external" href="ex16.html">16: Recreating the Cluster Using Ansible</a></li>
                                <li><a class="reference external" href="ex17.html">17: Advanced Usage of the Marathon</a></li>
                                <li><a class="reference external" href="ex18.html">18: Advanced Usage of Chronos</a></li>
                                <li><a class="reference external" href="ex19.html">19: Troubleshooting</a></li>
                                <li><a class="reference external" href="ex20.html">20: Advanced Cluster Building</a></li>
                            </ul> 
                        </div>

                    </div>
                    <div class="col-md-9">

                        <!--- RST STARTS -->
                        <h1 class="title">Exercise 16: Recreating the Cluster Using Ansible</h1>
                        <p>You have a miniature Mesosphere cluster running on your computer, but what would happen if you had to destroy it and start over?  Luckily we have the <a class="reference external" href="http://www.ansible.com/home">Ansible</a> tool where you can run one command to recreate your entire little cluster.</p>
<p>This exercise shows you how to create an Ansible playbook that can recreate the entire cluster
that you manually created for the last 15 exercises.  You could have started with this, but then you wouldn't
have known all the core concepts of Meso, Marathon, Chronos, and would be lost when you run into
trouble.</p>
<p>In this exercise:</p>
<ol class="arabic simple">
<li>Create a simple <tt class="docutils literal">playbook.yml</tt> file to get the master node working.</li>
<li>Change the <tt class="docutils literal">Vagrantfile</tt> to run Ansible and your playbook when provisioning.</li>
<li>Augment the <tt class="docutils literal">playbook.yml</tt> and <tt class="docutils literal">Vagrantfile</tt> to provision nodes 2-4.</li>
<li>Destroy everything and confirm you can rebuild everything with one command.</li>
</ol>
<div class="section" id="video-lecture">
<h1>Video Lecture</h1>
<style>.smart-player-embed-container-iframe{width:768px;height:576px}.smart-player-full-frame-mode{position:absolute;top:0;left:0;z-index:10;width:100%;height:100%;padding:0;margin:0}</style>
<div class="video-lecture-container">
        <iframe class="smart-player-embed-container-iframe" id="embeddedSmartPlayerInstance" src="https://s3-us-west-2.amazonaws.com/docs-staging.mesosphere.com/Videos/Mesos-Intro-Course-16/media/index_player.html?embedIFrameId=embeddedSmartPlayerInstance" scrolling="no"  frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
    </div>
<script src="media/scripts/embedded-smart-player.min.js"></script></div>
<div class="section" id="quick-reference">
<h1>Quick Reference</h1>
<p>To begin this exercise you will run <tt class="docutils literal">vagrant destroy</tt> to destroy the cluster you just built.  If you'd like to keep it around then feel free to make a  new directory for this exercise or backup the directory first.  Once you're ready do:</p>
<pre class="literal-block">
vagrant destroy -f
</pre>
<p>Now we can recreate everything with Ansible to automate the whole operation.  Ansible uses a YAML file to control how to build any Vagrant nodes, and Vagrant knows about Ansible configurations.  To get started, create a simple <tt class="docutils literal">playbook.yml</tt> file with this:</p>
<div class="highlight"><pre><a name="code--ex16--playbook.yml-jinja-idio.html-1"></a><span class="nn">---</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-2"></a><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">master</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-3"></a>  <span class="l-Scalar-Plain">remote_user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">vagrant</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-4"></a>  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-5"></a>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-6"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">update the hosts file</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-7"></a>        <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=./hosts.j2 dest=/etc/hosts</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-8"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">install the mesosphere yum repo</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-9"></a>        <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rpm -Uvh http://repos.mesosphere.com/el/7/noarch/RPMS/mesosphere-el-repo-7-1.noarch.rpm</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-10"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">install zookeeper repo</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-11"></a>        <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rpm -Uvh http://archive.cloudera.com/cdh4/one-click-install/redhat/6/x86_64/cloudera-cdh-4-0.x86_64.rpm</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-12"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">install zookeeper</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-13"></a>        <span class="l-Scalar-Plain">yum</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pkg=zookeeper,zookeeper-server state=latest</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-14"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">configure zookeeper ID</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-15"></a>        <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sudo -u zookeeper zookeeper-server-initialize --myid=1</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-16"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">install the mesos, marathon, chronos, docker packages</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-17"></a>        <span class="l-Scalar-Plain">yum</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pkg=device-mapper-event-libs,mesos,marathon,chronos,docker state=latest</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-18"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">configure containerizers</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-19"></a>        <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">echo &#39;docker,mesos&#39; | sudo tee /etc/mesos-slave/containerizers</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-20"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">start up zookeeper</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-21"></a>        <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=zookeeper-server state=started enabled=yes</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-22"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">start up the mesos-master</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-23"></a>        <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=mesos-master state=started enabled=yes</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-24"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">make sure mesos-slave is running</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-25"></a>        <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=mesos-slave state=started enabled=yes</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-26"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">start marathon</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-27"></a>        <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=marathon state=started enabled=yes</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-28"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">start chronos</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-29"></a>        <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=chronos state=started enabled=yes</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-30"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">start docker</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-31"></a>        <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=docker state=started enabled=yes</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-32"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">install go and dns tools</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-33"></a>        <span class="l-Scalar-Plain">yum</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pkg=golang,git,bind-utils state=latest</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-34"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">build mesos-dns</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-35"></a>        <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sudo -u vagrant sh /vagrant/installdns.sh</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-36"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">install outyet</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-37"></a>        <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sudo docker load --input=/vagrant/outyet.tar.gz</span>
</pre></div><p>This playbook uses a simple script to install Mesos DNS called <tt class="docutils literal">installdns.sh</tt>:</p>
<div class="highlight"><pre><a name="code--ex16--installdns.sh-jinja-idio.html-1"></a>mkdir ~/go
<a name="code--ex16--installdns.sh-jinja-idio.html-2"></a><span class="nb">export </span><span class="nv">GOPATH</span><span class="o">=</span><span class="nv">$HOME</span>/go
<a name="code--ex16--installdns.sh-jinja-idio.html-3"></a><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:<span class="nv">$GOPATH</span>/bin
<a name="code--ex16--installdns.sh-jinja-idio.html-4"></a>go get github.com/tools/godep
<a name="code--ex16--installdns.sh-jinja-idio.html-5"></a>go get github.com/mesosphere/mesos-dns
<a name="code--ex16--installdns.sh-jinja-idio.html-6"></a><span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/github.com/mesosphere/mesos-dns
<a name="code--ex16--installdns.sh-jinja-idio.html-7"></a>make restoredeps build
<a name="code--ex16--installdns.sh-jinja-idio.html-8"></a>cp /vagrant/config.json .
</pre></div><p>And make sure you create the following <tt class="docutils literal">config.json</tt> file from Exercise 7:</p>
<div class="highlight"><pre><a name="code--ex7--config.json-jinja-idio.html-1"></a><span class="p">{</span>
<a name="code--ex7--config.json-jinja-idio.html-2"></a>  <span class="nt">&quot;zk&quot;</span><span class="p">:</span> <span class="s2">&quot;zk://192.168.33.10:2181/mesos&quot;</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-3"></a>  <span class="nt">&quot;masters&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;192.168.33.10:5050&quot;</span><span class="p">],</span>
<a name="code--ex7--config.json-jinja-idio.html-4"></a>  <span class="nt">&quot;refreshSeconds&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-5"></a>  <span class="nt">&quot;ttl&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-6"></a>  <span class="nt">&quot;domain&quot;</span><span class="p">:</span> <span class="s2">&quot;mesos&quot;</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-7"></a>  <span class="nt">&quot;ns&quot;</span><span class="p">:</span> <span class="s2">&quot;ns1&quot;</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-8"></a>  <span class="nt">&quot;port&quot;</span><span class="p">:</span> <span class="mi">53</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-9"></a>  <span class="nt">&quot;resolvers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;8.8.8.8&quot;</span><span class="p">],</span>
<a name="code--ex7--config.json-jinja-idio.html-10"></a>  <span class="nt">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-11"></a>  <span class="nt">&quot;listener&quot;</span><span class="p">:</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-12"></a>  <span class="nt">&quot;SOAMname&quot;</span><span class="p">:</span> <span class="s2">&quot;root.ns1.mesos&quot;</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-13"></a>  <span class="nt">&quot;SOARname&quot;</span><span class="p">:</span> <span class="s2">&quot;ns1.mesos&quot;</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-14"></a>  <span class="nt">&quot;SOARefresh&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-15"></a>  <span class="nt">&quot;SOARetry&quot;</span><span class="p">:</span>   <span class="mi">600</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-16"></a>  <span class="nt">&quot;SOAExpire&quot;</span><span class="p">:</span>  <span class="mi">86400</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-17"></a>  <span class="nt">&quot;SOAMinttl&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-18"></a>  <span class="nt">&quot;dnson&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-19"></a>  <span class="nt">&quot;httpon&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-20"></a>  <span class="nt">&quot;httpport&quot;</span><span class="p">:</span> <span class="mi">8123</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-21"></a>  <span class="nt">&quot;externalon&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<a name="code--ex7--config.json-jinja-idio.html-22"></a>  <span class="nt">&quot;recurseon&quot;</span><span class="p">:</span> <span class="kc">true</span>
<a name="code--ex7--config.json-jinja-idio.html-23"></a><span class="p">}</span>
</pre></div><p>You next need this <tt class="docutils literal">hosts.j2</tt> file so Ansible can update your <tt class="docutils literal">/etc/hosts</tt> file:</p>
<div class="highlight"><pre><a name="code--ex15--hosts.j2-jinja-idio.html-1"></a>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
<a name="code--ex15--hosts.j2-jinja-idio.html-2"></a>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
<a name="code--ex15--hosts.j2-jinja-idio.html-3"></a>192.168.33.10 node1
<a name="code--ex15--hosts.j2-jinja-idio.html-4"></a>192.168.33.11 node2
<a name="code--ex15--hosts.j2-jinja-idio.html-5"></a>192.168.33.12 node3
<a name="code--ex15--hosts.j2-jinja-idio.html-6"></a>192.168.33.13 node4
</pre></div><p>And this <tt class="docutils literal">resolv.conf.j2</tt> file to update <tt class="docutils literal">/etc/resolv.conf</tt>:</p>
<div class="highlight"><pre><a name="code--ex16--resolv.conf.j2-jinja-idio.html-1"></a>nameserver 192.168.33.10
</pre></div><p>This will solve the problem of having proper host:ip mappings in our little cluster.
Modify the <tt class="docutils literal">Vagrantfile</tt> to be like this now:</p>
<div class="highlight"><pre><a name="code--ex16--Vagrant.rb-jinja-idio.html-1"></a><span class="no">ANSIBLE_GROUPS</span> <span class="o">=</span> <span class="p">{</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-2"></a>              <span class="s2">&quot;master&quot;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;node1&quot;</span><span class="o">]</span><span class="p">,</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-3"></a>              <span class="s2">&quot;nodes&quot;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;node2&quot;</span><span class="p">,</span> <span class="s2">&quot;node3&quot;</span><span class="p">,</span> <span class="s2">&quot;node4&quot;</span><span class="o">]</span><span class="p">,</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-4"></a>              <span class="s2">&quot;all_groups:children&quot;</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">&quot;master&quot;</span><span class="p">,</span> <span class="s2">&quot;nodes&quot;</span><span class="o">]</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-5"></a>            <span class="p">}</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-6"></a>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-7"></a>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-8"></a><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-9"></a>    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;chef/centos-7.0&quot;</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-10"></a>    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;node1&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">node1</span><span class="o">|</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-11"></a>        <span class="n">node1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.33.10&quot;</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-12"></a>        <span class="n">node1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;node1&quot;</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-13"></a>        <span class="n">node1</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-14"></a>            <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;playbook.yml&quot;</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-15"></a>            <span class="n">ansible</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="no">ANSIBLE_GROUPS</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-16"></a>        <span class="k">end</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-17"></a>    <span class="k">end</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-18"></a>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-19"></a>    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;node2&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">node2</span><span class="o">|</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-20"></a>        <span class="n">node2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.33.11&quot;</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-21"></a>        <span class="n">node2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;node2&quot;</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-22"></a>        <span class="n">node2</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-23"></a>            <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;playbook.yml&quot;</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-24"></a>            <span class="n">ansible</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="no">ANSIBLE_GROUPS</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-25"></a>        <span class="k">end</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-26"></a>    <span class="k">end</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-27"></a>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-28"></a>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-29"></a>    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;node3&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">node3</span><span class="o">|</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-30"></a>        <span class="n">node3</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.33.12&quot;</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-31"></a>        <span class="n">node3</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;node3&quot;</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-32"></a>        <span class="n">node3</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-33"></a>            <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;playbook.yml&quot;</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-34"></a>            <span class="n">ansible</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="no">ANSIBLE_GROUPS</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-35"></a>        <span class="k">end</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-36"></a>    <span class="k">end</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-37"></a>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-38"></a>    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="s2">&quot;node4&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">node4</span><span class="o">|</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-39"></a>        <span class="n">node4</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&quot;private_network&quot;</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;192.168.33.13&quot;</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-40"></a>        <span class="n">node4</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;node4&quot;</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-41"></a>        <span class="n">node4</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;ansible&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ansible</span><span class="o">|</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-42"></a>            <span class="n">ansible</span><span class="o">.</span><span class="n">playbook</span> <span class="o">=</span> <span class="s2">&quot;playbook.yml&quot;</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-43"></a>            <span class="n">ansible</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="no">ANSIBLE_GROUPS</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-44"></a>        <span class="k">end</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-45"></a>    <span class="k">end</span>
<a name="code--ex16--Vagrant.rb-jinja-idio.html-46"></a><span class="k">end</span>
</pre></div><p>Notice this is now stripped of the default comments and I've done the following to it:</p>
<ul class="simple">
<li>Created an <tt class="docutils literal">ANSIBLE_GROUPS</tt> variable to store our groupings for hosts.</li>
<li>Added a <tt class="docutils literal">node.vm.provision</tt> block to each node.</li>
<li>Added the <tt class="docutils literal">ansible.playbook</tt> and <tt class="docutils literal">ansible.groups</tt> settings inside that.</li>
<li>Removed the use of the <tt class="docutils literal"><span class="pre">mesos-master</span></tt> box from our previous exercises for <tt class="docutils literal">node1</tt>.</li>
</ul>
<p>Enter this command to get <tt class="docutils literal">node1</tt> working:</p>
<div class="highlight"><pre><a name="code--ex16--setup.sh-session-jinja-idio.html-1"></a><span class="gp">$</span> vagrant up node1
</pre></div><p>That should run every single thing necessary to get a master node up.  You should do the
usual tests of Marathon, Chronos, and Mesos as you've learned in Module 1.</p>
<p>Add a part of the <tt class="docutils literal">playbook.yml</tt> that configures the slave nodes
too:</p>
<div class="highlight"><pre><a name="code--ex16--playbook.yml-jinja-idio.html-1"></a><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">hosts</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">nodes</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-2"></a>  <span class="l-Scalar-Plain">remote_user</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">vagrant</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-3"></a>  <span class="l-Scalar-Plain">sudo</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">yes</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-4"></a>  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-5"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">update the hosts file</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-6"></a>        <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">src=./hosts.j2 dest=/etc/hosts</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-7"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">install the mesosphere yum repo</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-8"></a>        <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rpm -Uvh http://repos.mesosphere.com/el/7/noarch/RPMS/mesosphere-el-repo-7-1.noarch.rpm</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-9"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">install the mesos and docker packages</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-10"></a>        <span class="l-Scalar-Plain">yum</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">pkg=device-mapper-event-libs,mesos,docker state=latest</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-11"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">configure containerizers</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-12"></a>        <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">echo &#39;docker,mesos&#39; | sudo tee /etc/mesos-slave/containerizers</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-13"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">set the zookeeper master</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-14"></a>        <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sed -i -e &#39;s/localhost/192.168.33.10/g&#39; /etc/mesos/zk</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-15"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">make sure mesos-slave is running</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-16"></a>        <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=mesos-slave state=started enabled=yes</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-17"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">start docker</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-18"></a>        <span class="l-Scalar-Plain">service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">name=docker state=started enabled=yes</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-19"></a>      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">install outyet</span>
<a name="code--ex16--playbook.yml-jinja-idio.html-20"></a>        <span class="l-Scalar-Plain">shell</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sudo docker load --input=/vagrant/outyet.tar.gz</span>
</pre></div><p>Run this command to bring your nodes up:</p>
<div class="highlight"><pre><a name="code--ex16--setup.sh-session-jinja-idio.html-1"></a><span class="gp">$</span> vagrant up
</pre></div><p>And the remaining nodes will come up and be installed, but this time Vagrant will run Ansible to automatically configure everything.  This takes a while, but you can look at the Marathon GUI to watch everything come online while it's running.</p>
</div>
<div class="section" id="further-study">
<h1>Further Study</h1>
<ul class="simple">
<li>Destroy the whole cluster and recreate it with <tt class="docutils literal">vagrant up</tt>.</li>
<li>Review the Ansible documentation and learn more about it.</li>
</ul>
</div>
                        <!-- RST ENDS -->

                        <h2 id="comments">Ask For Help</h2>
                        <p>You can ask for help right here and a Mesosphere employee will respond within 24 hours.  Comments are moderated and will not show immediately.</p>
                        <div id="disqus_thread"></div>
                        <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                        var disqus_shortname = 'mesospheredocs'; // required: replace example with your forum shortname

                        /* * * DON'T EDIT BELOW THIS LINE * * */
                        (function() {
                         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                         })();
                        </script>
                        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


                    </div>
                </div>
                <!-- BODY END -->

                <!-- FOOTER START -->
                <footer>
                    <div class="container">
                        <div class="row">
                            <div class="col-sm-3 col-sm-offset-1">
                                <ul class="list-unstyled">
                                    <li><a href="http://mesosphere.com/team/">Team</a>
                                    <li><a href="http://mesosphere.com/news-events/">News &amp; Events</a></li>
                                    <li><a href="http://mesosphere.com/jobs/">Careers</a>
                                </ul>
                            </div>
                            <div class="col-sm-3 col-sm-offset-1">
                                <ul class="list-unstyled">
                                    <li><a href="http://mesosphere.com/resources/case-studies/">Case Studies</a>
                                    <li><a href="http://mesosphere.com/resources/research/">Research</a>
                                </ul>
                            </div>
                            <div class="col-sm-3 col-sm-offset-1">
                                <ul class="list-unstyled">
                                    <li><a href="https://twitter.com/mesosphere">@mesosphere</a>
                                    <li><span class="text-muted">&copy; 2015 Mesosphere, Inc.</span>
                                </ul>
                            </div>
                        </div>
                    </div>
                </footer>
                <!-- FOOTER END -->

            </div>

        </div>

        <script type="text/javascript">
!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.0.1";
    analytics.load("jb9aik674n");
    analytics.page()
}}();
        </script>
    </div>

    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/zeroclipboard/1.3.2/ZeroClipboard.min.js"></script>

    </body>

    </html>
