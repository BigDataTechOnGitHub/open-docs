<!DOCTYPE html>
<html lang="en">
<head>
<title>Exercise 20: Advanced Cluster Building</title>
<meta name="title" content ="Setting up a Single Node Mesosphere Cluster">

<meta name="description" content="Mesos allows you to create a highly-available and scalable cluster on your existing hardware.">

<meta name="keywords" content="mesos, mesosphere, apache mesos, cluster, mesos cluster, apache mesos, mesos tutorial, ETL, long-running services, service automation, distributed kernel, apache marathon, marathon tutorial, chronos tutorial, spark tutorial">
<meta name="googlebot" content="all" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css"
  rel="stylesheet">
<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css"
  rel="stylesheet">
<link rel="stylesheet" href="//dw8zztroqvu2r.cloudfront.net/assets/mesosphere-82a59fe27ee148f819ce1adf64a1bfd8.css">
<link rel="alternate" type="application/atom+xml" title="The Mesosphere Blog" href="/blog/atom.xml">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="//dw8zztroqvu2r.cloudfront.net/assets/apple-touch-icon-114x114-precomposed-e1bad1adfb238c042495e17882a75bee.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="//dw8zztroqvu2r.cloudfront.net/assets/apple-touch-icon-72x72-precomposed-e9561717ad14e807a3a6422bd2cf950d.png">
<link rel="apple-touch-icon-precomposed" href="//dw8zztroqvu2r.cloudfront.net/assets/apple-touch-icon-57x57-precomposed-1c3bb09d559f043cb58f2e36bd9b81bd.png">
<link rel="stylesheet" href="style.css">
    
    <script src="//cdn.optimizely.com/js/2009520669.js"></script>
    <script>
      window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(t){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)},window.analytics.SNIPPET_VERSION="2.0.8",
      window.analytics.load("7sgtwqvuai");
      window.analytics.page();
    </script>

</head>
<body>

<div class="navbar navbar-default  " role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>


            <a class="navbar-brand" href="http://mesosphere.com/">


                <img src="http://dw8zztroqvu2r.cloudfront.net/assets/mesosphere-165b872607f4d76434d9b1cfb41a6280.png" width="148" height="25" alt="Mesosphere">


            </a>
        </div>
        <div class="collapse navbar-collapse">
        </div>
    </div>
</div>

<div class="body-light">
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <div role="complementary">
                    <gcse:searchbox-only></gcse:searchbox-only>
                    <ul class="nav docs-sidenav">
                        <li><a class="reference external" href="intro.html">Introduction</a></li>
                        <li><a class="reference external" href="ex1.html">01: Installing Software</a></li>
                        <li><a class="reference external" href="ex2.html">02: Installing ZooKeeper</a></li>
                        <li><a class="reference external" href="ex3.html">03: Using Apache Mesos</a></li>
                        <li><a class="reference external" href="ex4.html">04: Starting Marathon</a></li>
                        <li><a class="reference external" href="ex5.html">05: Using the Marathon GUI</a></li>
                        <li><a class="reference external" href="ex6.html">06: Marathon REST API</a></li>
                        <li><a class="reference external" href="ex7.html">07: Building and Running Mesos DNS</a></li>
                        <li><a class="reference external" href="ex8.html">08: Installing Chronos</a></li>
                        <li><a class="reference external" href="ex9.html">09: Creating A Slave Node</a></li>
                        <li><a class="reference external" href="ex10.html">10: Installing Mesos</a></li>
                        <li><a class="reference external" href="ex11.html">11: Scaling To Two Nodes</a></li>
                        <li><a class="reference external" href="ex12.html">12: Deploying A Web App With Docker</a></li>
                        <li><a class="reference external" href="ex13.html">13: Distributing Docker To Multiple Nodes</a></li>
                        <li><a class="reference external" href="ex14.html">14: Installing and Using Mesos CLI</a></li>
                        <li><a class="reference external" href="ex15.html">15: Starting Four Nodes</a></li>
                        <li><a class="reference external" href="ex16.html">16: Recreating the Cluster Using Ansible</a></li>
                        <li><a class="reference external" href="ex17.html">17: Advanced Usage of the Marathon</a></li>
                        <li><a class="reference external" href="ex18.html">18: Advanced Usage of Chronos</a></li>
                        <li><a class="reference external" href="ex19.html">19: Troubleshooting</a></li>
                        <li><a class="reference external" href="ex20.html">20: Advanced Cluster Building</a></li>
                    </ul> 
                </div>

            </div>
            <div class="col-md-8">

                <!--- RST STARTS -->
                <h1 class="title">Exercise 20: Advanced Cluster Building</h1>
                <p><strong>Warning</strong> This exercise is currently being developed and does not work.</p>
<p>This final exercise teaches you how to use your Ansible configuration
to craft Virtualbox templates that you can use to build more nodes in the cluster.
This is to simulate how to combine Ansible with VM templates to get more
repeatable builds for your node.</p>
<p>In this exercise:</p>
<ol class="arabic simple">
<li>Use Ansible, Chef, or Puppet to craft nodes locally.</li>
<li>Save them to a template file once they work well and you need to deploy.</li>
<li>Use that template to then seed your cluster quicker and more reliably to get base node configuration.</li>
<li>Let Marathon get the rest of your infrastructure running using Docker applications.</li>
</ol>
<div class="section" id="video-lecture">
<h1>Video Lecture</h1>
<p>Video lecture pending for this exercise.</p>
</div>
<div class="section" id="quick-reference">
<h1>Quick Reference</h1>
<p>Run the new <tt class="docutils literal">nodes</tt> configuration for your slave nodes that disables a few more things and gets the ready for this first phase:</p>
<pre class="literal-block">
- hosts: nodes
  remote_user: vagrant
  sudo: yes
  tasks:
      - name: update the hosts file
        template: src=./hosts.j2 dest=/etc/hosts
      - name: install the mesosphere yum repo
        shell: rpm -Uvh http://repos.mesosphere.io/el/7/noarch/RPMS/mesosphere-el-repo-7-1.noarch.rpm
      - name: install the mesos and docker packages
        yum: pkg=mesos,docker state=latest
      - name: set the zookeeper master
        shell: sed -i -e 's/localhost/192.168.33.10/g' /etc/mesos/zk
      - name: make sure mesos-slave is running
        service: name=mesos-slave state=started enabled=yes
      - name: disable the mesos-master by default
        shell: chkconfig mesos-master off
      - name: enable docer in mesos slaves
        shell: echo &quot;docker,mesos&quot; &gt;&gt; /etc/mesos-slave/containerizers
      - name: kill the slave state
        shell: rm -rf /tmp/mesos*
      - name: restart the mesos-slave
        shell: service mesos-slave restart
      - name: start docker
        service: name=docker state=started enabled=yes
      - name: install outyet
        shell: sudo docker load --input=/vagrant/outyet.tar.gz
</pre>
<p>This is effectively adding cleaning out some <tt class="docutils literal"><span class="pre">mesos-slave</span></tt> state before the server starts, but later we'll do this again to <tt class="docutils literal">node2</tt> to get it ready for saving.</p>
<p>Run <tt class="docutils literal">vagrant destroy</tt>:</p>
<pre class="literal-block">
vagrant destroy -f &amp;&amp; vagrant up node1 node2
</pre>
<p>To confirm that your <tt class="docutils literal">playbook.yml</tt> works and can build the master and the first slave.</p>
<p>Use <tt class="docutils literal">node2</tt> to craft a Vagrant box (image) that you can use
to recreate <tt class="docutils literal">node3</tt> and <tt class="docutils literal">node4</tt>.  Before you can do this you have to clean up the <tt class="docutils literal">node2</tt> image with these commands:</p>
<pre class="literal-block">
#!/bin/bash
sudo service mesos-master stop
sudo chkconfig mesos-master off
echo &quot;docker,mesos&quot; | sudo tee /etc/mesos-slave/containerizers
sudo rm -rf /tmp/mesos*
sudo service mesos-slave stop
sudo docker rm test
</pre>
<p>Save this to a file in <tt class="docutils literal">/vagrant/start.sh</tt> and then do:</p>
<pre class="literal-block">
vagrant ssh node2
sh /vagrant/start.sh
exit
vagrant halt node2
</pre>
<p>Save the <tt class="docutils literal">node2</tt> Vagrant box to a new <tt class="docutils literal"><span class="pre">mesos-slave</span></tt> box:</p>
<pre class="literal-block">
rm -f package.box
vagrant package node2
vagrant box add mesos-slave package.box
</pre>
<p>Destroy the <tt class="docutils literal">node3</tt> and <tt class="docutils literal">node4</tt> to get them ready to build based on the new configuration:</p>
<pre class="literal-block">
vagrant destroy -f node3 node4
</pre>
<p>You have to do this before changing the <tt class="docutils literal">Vagrantfile</tt> or else Vagrant can't find them.</p>
<p>Change the configuration for <tt class="docutils literal">node3</tt> and <tt class="docutils literal">node4</tt> to:</p>
<pre class="literal-block">
config.vm.define &quot;node3&quot; do |node3|
    node3.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.12&quot;
    node3.vm.hostname = &quot;node3&quot;
    node3.vm.box = &quot;mesos-slave&quot;
end

config.vm.define &quot;node4&quot; do |node4|
    node4.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.13&quot;
    node4.vm.hostname = &quot;node4&quot;
    node4.vm.box = &quot;mesos-slave&quot;
end
</pre>
<p>Special note is that you are <em>not</em> setting the hostname, as you'll have a preconfigured set of hosts in the <tt class="docutils literal">/etc/hosts</tt> file from the <tt class="docutils literal">hosts.j2</tt> template used to build <tt class="docutils literal">node2</tt>.</p>
<p>Run <tt class="docutils literal">vagrant up</tt> to build using the node template rather than with Ansible.</p>
<p><strong>Important</strong>
There are currently these two issues with this configuration:</p>
<ul class="simple">
<li>You still have to edit the /etc/hosts file because Vagrant insists on adding the host name to it even if you don't need to.</li>
<li>You typically have to run <tt class="docutils literal">sudo docker rm test</tt> on nodes when they start.</li>
</ul>
</div>
<div class="section" id="final-configuration">
<h1>Final Configuration</h1>
<p>Your final Ansible <tt class="docutils literal">playbook.yml</tt> is now this:</p>
<pre class="literal-block">
---
- hosts: master
  remote_user: vagrant
  sudo: yes
  tasks:
      - name: update the hosts file
        template: src=./hosts.j2 dest=/etc/hosts
      - name: update the rsyslog config
        template: src=./mesos.conf.j2 dest=/etc/rsyslog.d/mesos.conf
      - name: restart rsyslog
        shell: service rsyslog restart
      - name: install the mesosphere yum repo
        shell: rpm -Uvh http://repos.mesosphere.io/el/7/noarch/RPMS/mesosphere-el-repo-7-1.noarch.rpm
      - name: install zookeeper repo
        shell: rpm -Uvh http://archive.cloudera.com/cdh4/one-click-install/redhat/6/x86_64/cloudera-cdh-4-0.x86_64.rpm
      - name: install zookeeper
        yum: pkg=zookeeper,zookeeper-server state=latest
      - name: configure zookeeper ID
        shell: sudo -u zookeeper zookeeper-server-initialize --myid=1
      - name: install the mesos, marathon, chronos, docker packages
        yum: pkg=mesos,marathon,chronos,docker state=latest
      - name: start up zookeeper
        service: name=zookeeper-server state=started enabled=yes
      - name: start up mesos-master
        service: name=mesos-master state=started enabled=yes
      - name: make sure mesos-slave is running
        service: name=mesos-slave state=started enabled=yes
      - name: start marathon
        service: name=marathon state=started enabled=yes
      - name: start chronos
        service: name=chronos state=started enabled=yes
      - name: start docker
        service: name=docker state=started enabled=yes
      - name: install go and dns tools
        yum: pkg=golang,git,bind-utils state=latest
      - name: build mesos-dns
        shell: sudo -u vagrant sh /vagrant/installdns.sh
      - name: install outyet
        shell: sudo docker load --input=/vagrant/outyet.tar.gz
      - name: start marathon services
        shell: cd /vagrant/marathon &amp;&amp; sh post.sh
      - name: install ruby
        yum: pkg=ruby state=latest
      - name: sync chronos jobs
        shell: ruby /vagrant/chronos-sync.rb -u http://192.168.33.10:4400/ -p /vagrant/chronos
- hosts: nodes
  remote_user: vagrant
  sudo: yes
  tasks:
      - name: update the hosts file
        template: src=./hosts.j2 dest=/etc/hosts
      - name: install the mesosphere yum repo
        shell: rpm -Uvh http://repos.mesosphere.io/el/7/noarch/RPMS/mesosphere-el-repo-7-1.noarch.rpm
      - name: install the mesos and docker packages
        yum: pkg=mesos,docker state=latest
      - name: set the zookeeper master
        shell: sed -i -e 's/localhost/192.168.33.10/g' /etc/mesos/zk
      - name: make sure mesos-slave is running
        service: name=mesos-slave state=started enabled=yes
      - name: disable the mesos-master by default
        shell: chkconfig mesos-master off
      - name: enable docer in mesos slaves
        shell: echo &quot;docker,mesos&quot; &gt;&gt; /etc/mesos-slave/containerizers
      - name: kill the slave state
        shell: rm -rf /tmp/mesos*
      - name: restart the mesos-slave
        shell: service mesos-slave restart
      - name: start docker
        service: name=docker state=started enabled=yes
      - name: install outyet
        shell: sudo docker load --input=/vagrant/outyet.tar.gz
</pre>
<p>And your final <tt class="docutils literal">Vagrantfile</tt> is this:</p>
<pre class="literal-block">
# -*- mode: ruby -*-
# vi: set ft=ruby :

ANSIBLE_GROUPS = {
              &quot;master&quot; =&gt; [&quot;node1&quot;],
              &quot;nodes&quot; =&gt; [&quot;node2&quot;],
              &quot;all_groups:children&quot; =&gt; [&quot;master&quot;, &quot;nodes&quot;]
            }


Vagrant.configure(2) do |config|
    config.vm.box = &quot;chef/centos-7.0&quot;

    config.vm.define &quot;node1&quot; do |node1|
        node1.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.10&quot;
        node1.vm.hostname = &quot;node1&quot;
        #node1.vm.box = &quot;mesos-master&quot;
        node1.vm.provision &quot;ansible&quot; do |ansible|
            ansible.playbook = &quot;playbook.yml&quot;
            ansible.groups = ANSIBLE_GROUPS
        end
    end

    config.vm.define &quot;node2&quot; do |node2|
        node2.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.11&quot;
        node2.vm.hostname = &quot;node2&quot;
        node2.vm.provision &quot;ansible&quot; do |ansible|
            ansible.playbook = &quot;playbook.yml&quot;
            ansible.groups = ANSIBLE_GROUPS
        end
    end

    config.vm.define &quot;node3&quot; do |node3|
        node3.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.12&quot;
        node3.vm.hostname = &quot;node3&quot;
        node3.vm.box = &quot;mesos-slave&quot;
    end

    config.vm.define &quot;node4&quot; do |node4|
        node4.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.13&quot;
        node4.vm.hostname = &quot;node4&quot;
        node4.vm.box = &quot;mesos-slave&quot;
    end
end
</pre>
<p>With these two files, and the <tt class="docutils literal">marathon</tt> and <tt class="docutils literal">chronos</tt> configuration directories, you are now able to build a full Mesos cluster repeatably and you should be able to
move this similar build to your own cluster.</p>
</div>
<div class="section" id="further-study">
<h1>Further Study</h1>
<p>This is the end of the first course.  More to come as we receive feedback on it and will have some further study then.</p>
</div>
                <!-- RST ENDS -->

                <h2 id="comments">Ask For Help</h2>
                <p>You can ask for help right here and a Mesosphere employee will respond within 24 hours.  Comments are moderated and will not show immediately.</p>
                <div id="disqus_thread"></div>
                <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'mesospheredocs'; // required: replace example with your forum shortname

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                 dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                 })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


            </div>

        </div>

        <script type="text/javascript">
!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.0.1";
    analytics.load("jb9aik674n");
    analytics.page()
}}();
        </script>
    </div>
    <footer class=" ">
        <div class="container">
            <div class="row">
                <div class="col-sm-3">
                    <ul class="list-unstyled">
                        <li><a href="http://mesosphere.com/team/">Team</a>
                        <li><a href="http://mesosphere.com/news-events/">News &amp; Events</a></li>
                        <li><a href="http://mesosphere.com/jobs/">Careers</a>
                    </ul>
                </div>
                <div class="col-sm-3">
                    <ul class="list-unstyled">
                        <li><a href="http://mesosphere.com/resources/case-studies/">Case Studies</a>
                        <li><a href="http://mesosphere.com/resources/research/">Research</a>
                    </ul>
                </div>
                <div class="col-sm-3">
                    <ul class="list-unstyled">
                        <li><a href="https://twitter.com/mesosphere">@mesosphere</a>
                        <li><span class="text-muted">&copy; 2015 Mesosphere, Inc.</span>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/zeroclipboard/1.3.2/ZeroClipboard.min.js"></script>

    </body>

    </html>
