<!DOCTYPE html>
<html lang="en">
<head>
<title>Exercise 17: Advanced Usage of the Marathon</title>
<meta name="title" content ="Setting up a Single Node Mesosphere Cluster">

<meta name="description" content="Mesos allows you to create a highly-available and scalable cluster on your existing hardware.">

<meta name="keywords" content="mesos, mesosphere, apache mesos, cluster, mesos cluster, apache mesos, mesos tutorial, ETL, long-running services, service automation, distributed kernel, apache marathon, marathon tutorial, chronos tutorial, spark tutorial">
<meta name="googlebot" content="all" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.min.css"
  rel="stylesheet">
<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css"
  rel="stylesheet">
<link rel="stylesheet" href="//dw8zztroqvu2r.cloudfront.net/assets/mesosphere-82a59fe27ee148f819ce1adf64a1bfd8.css">
<link rel="alternate" type="application/atom+xml" title="The Mesosphere Blog" href="/blog/atom.xml">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="//dw8zztroqvu2r.cloudfront.net/assets/apple-touch-icon-114x114-precomposed-e1bad1adfb238c042495e17882a75bee.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="//dw8zztroqvu2r.cloudfront.net/assets/apple-touch-icon-72x72-precomposed-e9561717ad14e807a3a6422bd2cf950d.png">
<link rel="apple-touch-icon-precomposed" href="//dw8zztroqvu2r.cloudfront.net/assets/apple-touch-icon-57x57-precomposed-1c3bb09d559f043cb58f2e36bd9b81bd.png">
<link rel="stylesheet" href="style.css">
    
    <script src="//cdn.optimizely.com/js/2009520669.js"></script>
    <script>
      window.analytics||(window.analytics=[]),window.analytics.methods=["identify","track","trackLink","trackForm","trackClick","trackSubmit","page","pageview","ab","alias","ready","group","on","once","off"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var method=window.analytics.methods[i];window.analytics[method]=window.analytics.factory(method)}window.analytics.load=function(t){var a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)},window.analytics.SNIPPET_VERSION="2.0.8",
      window.analytics.load("7sgtwqvuai");
      window.analytics.page();
    </script>

</head>
<body>

<div class="navbar navbar-default  " role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>


            <a class="navbar-brand" href="http://mesosphere.com/">


                <img src="http://dw8zztroqvu2r.cloudfront.net/assets/mesosphere-165b872607f4d76434d9b1cfb41a6280.png" width="148" height="25" alt="Mesosphere">


            </a>
        </div>
        <div class="collapse navbar-collapse">
        </div>
    </div>
</div>

<div class="body-light">
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <div role="complementary">
                    <gcse:searchbox-only></gcse:searchbox-only>
                    <ul class="nav docs-sidenav">
                        <li><a class="reference external" href="intro.html">Introduction</a></li>
                        <li><a class="reference external" href="ex1.html">01: Installing Software</a></li>
                        <li><a class="reference external" href="ex2.html">02: Installing ZooKeeper</a></li>
                        <li><a class="reference external" href="ex3.html">03: Using Apache Mesos</a></li>
                        <li><a class="reference external" href="ex4.html">04: Starting Marathon</a></li>
                        <li><a class="reference external" href="ex5.html">05: Using the Marathon GUI</a></li>
                        <li><a class="reference external" href="ex6.html">06: Marathon REST API</a></li>
                        <li><a class="reference external" href="ex7.html">07: Building and Running Mesos DNS</a></li>
                        <li><a class="reference external" href="ex8.html">08: Installing Chronos</a></li>
                        <li><a class="reference external" href="ex9.html">09: Creating A Slave Node</a></li>
                        <li><a class="reference external" href="ex10.html">10: Installing Mesos</a></li>
                        <li><a class="reference external" href="ex11.html">11: Scaling To Two Nodes</a></li>
                        <li><a class="reference external" href="ex12.html">12: Deploying A Web App With Docker</a></li>
                        <li><a class="reference external" href="ex13.html">13: Distributing Docker To Multiple Nodes</a></li>
                        <li><a class="reference external" href="ex14.html">14: Installing and Using Mesos CLI</a></li>
                        <li><a class="reference external" href="ex15.html">15: Starting Four Nodes</a></li>
                        <li><a class="reference external" href="ex16.html">16: Recreating the Cluster Using Ansible</a></li>
                        <li><a class="reference external" href="ex17.html">17: Advanced Usage of the Marathon</a></li>
                        <li><a class="reference external" href="ex18.html">18: Advanced Usage of Chronos</a></li>
                        <li><a class="reference external" href="ex19.html">19: Troubleshooting</a></li>
                        <li><a class="reference external" href="ex20.html">20: Advanced Cluster Building</a></li>
                    </ul> 
                </div>

            </div>
            <div class="col-md-8">

                <!--- RST STARTS -->
                <h1 class="title">Exercise 17: Advanced Usage of the Marathon</h1>
                <p>After you have Ansible creating a repeatable build of your four node mini-cluster you'll want to also rebuild your Marathon configuration.  The Marathon GUI is good for basic Marathon usage, but the real power comes from using the Marathon REST API.  Using the REST API you can keep track of your configurations in a <tt class="docutils literal">git</tt> repository, providing you with version control and use the API to change or rebuild your configurations as needed.</p>
<p>In this exercise:</p>
<ol class="arabic simple">
<li>Create a simple Marathon configuration repository with .json files for configuration.</li>
<li>Use <tt class="docutils literal">curl</tt> to post them to Marathon as part of the Ansible build.</li>
<li>Add health checks to your Marathon tasks to ensure quality of service.</li>
<li>Configure SSL and a Basic Authentication password for Marathon to secure it.</li>
<li>Review the Marathon documentation to learn about other advanced topics.</li>
</ol>
<div class="section" id="video-lecture">
<h1>Video Lecture</h1>
<style>.smart-player-embed-container-iframe{width:768px;height:576px}.smart-player-full-frame-mode{position:absolute;top:0;left:0;z-index:10;width:100%;height:100%;padding:0;margin:0}</style>
<iframe class="smart-player-embed-container-iframe" id="embeddedSmartPlayerInstance" src="https://s3-us-west-2.amazonaws.com/docs-staging.mesosphere.com/Videos/Mesos-Intro-Course-17/media/index_player.html?embedIFrameId=embeddedSmartPlayerInstance" scrolling="no"  frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>
<script src="media/scripts/embedded-smart-player.min.js"></script></div>
<div class="section" id="quick-reference">
<h1>Quick Reference</h1>
<p>In your VM directory make a <tt class="docutils literal">marathon</tt> directory and get it started with <tt class="docutils literal">git init</tt>:</p>
<pre class="literal-block">
mkdir marathon
cd marathon
git init marathon
</pre>
<p>Make a <tt class="docutils literal">webapp.json</tt> file:</p>
<pre class="literal-block">
{
  &quot;id&quot;: &quot;test&quot;,
  &quot;cmd&quot;: &quot;python -m SimpleHTTPServer $PORT0&quot;,
  &quot;cpus&quot;: 0.5,
  &quot;mem&quot;: 20.0,
  &quot;instances&quot;: 4,
  &quot;healthChecks&quot;: [
    {
      &quot;protocol&quot;: &quot;HTTP&quot;,
      &quot;portIndex&quot;: 0,
      &quot;path&quot;: &quot;/&quot;,
      &quot;gracePeriodSeconds&quot;: 5,
      &quot;intervalSeconds&quot;: 20,
      &quot;maxConsecutiveFailures&quot;: 3
    }
  ],
  &quot;ports&quot;: [4000],
  &quot;constraints&quot;: [
        [&quot;hostname&quot;, &quot;UNIQUE&quot;, &quot;&quot;]
    ]
}
</pre>
<p>Use this simple bash script to make it easier to load JSON files into Marathon:</p>
<pre class="literal-block">
#!/usr/bin/env bash
MARATHON=http://192.168.33.10:8080

for i in *.json
do
    curl -X POST $MARATHON/v2/apps -d &#64;$i -H &quot;Content-type: application/json&quot;
done
</pre>
<p>This is simply using <tt class="docutils literal">curl</tt> to loop through every .json file and then send it to Marathon with a POST HTTP request.
Run this to add your webapp to it:</p>
<pre class="literal-block">
chmod u+x post.sh
./post.sh
</pre>
<p>Create the <tt class="docutils literal">dns.json</tt> file for Mesos DNS:</p>
<pre class="literal-block">
{
  &quot;id&quot;: &quot;dns&quot;,
  &quot;cmd&quot;: &quot;sudo /home/vagrant/go/src/github.com/mesosphere/mesos-dns/mesos-dns -v -config=/home/vagrant/go/src/github.com/mesosphere/mesos-dns/config.json&quot;,
  &quot;cpus&quot;: 0.5,
  &quot;mem&quot;: 20.0,
  &quot;instances&quot;: 1,
  &quot;ports&quot;: [4000],
  &quot;constraints&quot;: [
        [&quot;hostname&quot;, &quot;CLUSTER&quot;, &quot;node1&quot;]
    ]
}
</pre>
<p>Create this <tt class="docutils literal">outyet.json</tt> file to setup the outyet application:</p>
<pre class="literal-block">
{
  &quot;id&quot;: &quot;outyet&quot;,
  &quot;cmd&quot;: &quot;sudo docker run --publish 6060:8080 --name test --rm outyet&quot;,
  &quot;cpus&quot;: 0.2,
  &quot;mem&quot;: 30.0,
  &quot;instances&quot;: 1,
  &quot;constraints&quot;: [
        [&quot;hostname&quot;, &quot;UNIQUE&quot;, &quot;&quot;]
    ]
}
</pre>
<p>Run <tt class="docutils literal">post.sh</tt> from the <tt class="docutils literal">marathon</tt> directory to have it install your applications:</p>
<pre class="literal-block">
./post.sh
</pre>
<p>Add this to your Ansible <tt class="docutils literal">playbook.yml</tt> so that it's done during your build:</p>
<pre class="literal-block">
- name: start marathon services
  shell: cd /vagrant/marathon &amp;&amp; sh post.sh
</pre>
</div>
<div class="section" id="additional-commands">
<h1>Additional Commands</h1>
<p>This automates your Marathon configuration and adds it to the Ansible <tt class="docutils literal">playbook.yml</tt> file so that you can repeat it.  You'll also need to know the following common commands:</p>
<pre class="literal-block">
# list out the apps availale
curl http://192.168.33.10:8080/v2/apps

# delete an app from Marathon
curl -X DELETE http://192.168.33.10:8080/v2/apps/webapp

# update the configuration of an app
curl -X PUT http://192.168.33.10:8080/v2/apps/webapp -dwebapp.json -H &quot;Content-type: application/json&quot;

# list the tasks of an app
curl http://192.168.33.10:8080/v2/apps/webapp/tasks

# delete the tasks of an app
curl -X DELETE http://192.168.33.10:8080/v2/apps/webapp/tasks
</pre>
</div>
<div class="section" id="further-study">
<h1>Further Study</h1>
<ul class="simple">
<li>Read more about the API endpoints available for Marathon at <a class="reference external" href="https://mesosphere.github.io/marathon/docs/rest-api.html">https://mesosphere.github.io/marathon/docs/rest-api.html</a></li>
</ul>
</div>
                <!-- RST ENDS -->

                <h2 id="comments">Ask For Help</h2>
                <p>You can ask for help right here and a Mesosphere employee will respond within 24 hours.  Comments are moderated and will not show immediately.</p>
                <div id="disqus_thread"></div>
                <script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                var disqus_shortname = 'mesospheredocs'; // required: replace example with your forum shortname

                /* * * DON'T EDIT BELOW THIS LINE * * */
                (function() {
                 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                 dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                 })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


            </div>

        </div>

        <script type="text/javascript">
!function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","group","track","ready","alias","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t){var e=document.createElement("script");e.type="text/javascript";e.async=!0;e.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(e,n)};analytics.SNIPPET_VERSION="3.0.1";
    analytics.load("jb9aik674n");
    analytics.page()
}}();
        </script>
    </div>
    <footer class=" ">
        <div class="container">
            <div class="row">
                <div class="col-sm-3">
                    <ul class="list-unstyled">
                        <li><a href="http://mesosphere.com/team/">Team</a>
                        <li><a href="http://mesosphere.com/news-events/">News &amp; Events</a></li>
                        <li><a href="http://mesosphere.com/jobs/">Careers</a>
                    </ul>
                </div>
                <div class="col-sm-3">
                    <ul class="list-unstyled">
                        <li><a href="http://mesosphere.com/resources/case-studies/">Case Studies</a>
                        <li><a href="http://mesosphere.com/resources/research/">Research</a>
                    </ul>
                </div>
                <div class="col-sm-3">
                    <ul class="list-unstyled">
                        <li><a href="https://twitter.com/mesosphere">@mesosphere</a>
                        <li><span class="text-muted">&copy; 2015 Mesosphere, Inc.</span>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.0/js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/zeroclipboard/1.3.2/ZeroClipboard.min.js"></script>

    </body>

    </html>
